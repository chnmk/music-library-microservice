# Сервис для библиотеки песен
Получает, возвращает, меняет и удаляет данные о песнях в соответствии с запросами. Получает тексты песен запросами к стороннему API. Данные хранятся в PostgreSQL.

## Содержание
1. [Функционал](#функционал)
2. [Сторонние библиотеки](#сторонние-библиотеки)
3. [Запуск сервиса](#запуск-сервиса)
4. [Переменные окружения](#переменные-окружения)
5. [Тестирование](#тестирование)


## Функционал

Данные о песнях хранятся в таблицах `artists` и `songs`, связанных через поле `artist_id`. 

Получение текста, удаление и изменение песни происходит не через ID, который может быть неизвестен клиенту, а через параметры `artist` и `song`. При запросе на удаление сначала производится удаление песни. Если у исполнителя больше не осталось связанных с ним песен, происходит удаление самого исполнителя.

При запросе данных из библиотеки есть возможность фильтрации по имени исполнителя, названию песни и тексту. Также есть возможность запросить конкретную страницу результатов, а не все сразу. Количество песен на одной странице определяется переменной окружения `PAGE_SIZE` (по умолчанию `10`).

Информация о текстах песен запрашивается из стороннего API. Резервное хранение данных производится через PostgreSQL. Есть возможность восстановления данных из БД при запуске (переменная окружения `RESTORE_FROM_DB`)

Логирование реализовано через `slog`. Файл `swagger.yaml` сгенерирован через [swaggo](https://github.com/swaggo/swag).

## Сторонние библиотеки
- [pgx v5.7.1](https://github.com/jackc/pgx/v5) - для подключения к PostgreSQL
- [migrate v4.18.2](https://github.com/golang-migrate/migrate/) - для управления миграциями БД
- [godotenv v1.5.1](https://github.com/joho/godotenv) -  для получения переменных окружения из .env файла

## Запуск сервиса

Команда для запуска из корневой папки: `go run cmd/main.go`.

Сервис можно запустить через Docker Compose вместе с PostgreSQL (файл `compose.yaml`). Для запуска можно использовать команду `docker compose up --attach muslib`. Необходимые переменные окружения:

```
# Указаны значения по умолчанию
POSTGRES_USER=user
POSTGRES_PASSWORD=12345
POSTGRES_DB=muslib
```

## Переменные окружения
Список переменных окружения со стандартными значениями:

```
# Порт, на котором будет поднят сервер
SERVER_PORT = 3000

# Адрес сервера для получения текста песен и максимальное время запроса в секундах 
REQUEST_SERVER = localhost:3001
REQUEST_TIMEOUT = 1

# Строка подключения к БД формируется следующим образом:
# DB_PROTOCOL://POSTGRES_USER:POSTGRES_PASSWORD@DB_HOST:DB_PORT/POSTGRES_DB
POSTGRES_USER=user
POSTGRES_PASSWORD=12345
POSTGRES_DB=muslib

# Для запуска через Docker Compose эти переменные необходимо указать:
DB_PROTOCOL=postgres
DB_HOST=postgres
DB_PORT=5432 
SSL_MODE=disable

# Настройки самого сервиса
LOG_LEVEL = debug # либо info
PAGE_SIZE = 10 # количество песен в одной странице
```

## Тестирование

Частично написаны автотесты на пакеты transport, services, database. Запуск тестов:

```
go test ./...
```
